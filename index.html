<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONEFLOW 360 PRO Calculator</title>
    
    <!-- טעינת ספריות חיצוניות (גרסה יציבה) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- פונטים -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Heebo', sans-serif; 
            background-color: #f8fafc;
            color: #0f172a;
            -webkit-font-smoothing: antialiased;
        }

        /* התאמת סליידרים ל-RTL */
        input[type="range"] { direction: ltr; }

        /* גלילה נעימה */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: transparent; }

        /* --- הגדרות הדפסה (PDF) משודרגות --- */
        @media print {
            @page { size: A4; margin: 10mm; }
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            /* הסתרת כל מה שלא קשור להדפסה */
            .no-print, header, button, .admin-modal, .mobile-bar { display: none !important; }
            
            /* הצגת אזור ההדפסה בלבד */
            #print-area { 
                display: block !important; 
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                z-index: 9999;
                background: white;
            }

            /* עיצוב טבלאות וכותרות להדפסה */
            .print-container { padding: 0 10px; }
            
            h1 { font-size: 24pt !important; font-weight: 900 !important; color: #1e3a8a !important; margin: 0; }
            .print-sub-header { color: #64748b !important; font-size: 11pt !important; }
            
            h2 { 
                font-size: 16pt !important; 
                font-weight: 800 !important; 
                color: #1e293b !important; 
                margin-top: 25px !important; 
                margin-bottom: 10px !important; 
                border-bottom: 2px solid #e2e8f0 !important;
                padding-bottom: 5px !important;
            }

            /* טבלה נקייה */
            table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10pt; }
            th { background-color: #f1f5f9 !important; padding: 8px; text-align: right; font-weight: 800; border: 1px solid #e2e8f0; }
            td { padding: 8px; border: 1px solid #e2e8f0; vertical-align: top; }
            
            /* קופסאות סיכום */
            .summary-box {
                background-color: #f8fafc !important;
                border: 2px solid #cbd5e1 !important;
                border-radius: 12px;
                padding: 15px;
                break-inside: avoid;
            }

            .badge { 
                border: 1px solid #ddd; 
                padding: 2px 6px; 
                border-radius: 4px; 
                font-size: 8pt; 
                font-weight: bold; 
            }
        }
        
        /* הסתרת אזור ההדפסה במסך רגיל */
        #print-area { display: none; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // רכיב אייקון דינמי
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]); 
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // רשימת אייקונים מורחבת לבחירה
        const ICON_LIST = [
            'shopping-cart', 'package', 'layers', 'truck', 'megaphone', 'mail', 'briefcase', 'bar-chart-3',
            'activity', 'users', 'puzzle', 'globe', 'shield', 'zap', 'coins', 'hammer', 'clock', 'calendar',
            'database', 'settings', 'check-circle-2', 'file-text', 'server', 'smartphone', 'wifi', 'box'
        ];

        // --- נתוני ברירת מחדל ---
        const DEFAULT_CONFIG = {
            basePricePerModule: 100,
            basePricePerUser: 45,
            exchangeRate: 3.7, 
            setupHourlyRate: 350,
            setupHoursPerDay: 9,
            uiText: {
                modulesHeader: "רכיב א': מודולים פעילים",
                usersHeader: "רכיב ב': משתמשים",
                tiersHeader: "רכיב ג': חבילת טרנזקציות",
                aiHeader: "רכיב ד': כוח AI",
            },
            modules: [
                { id: 'sales', name: 'מכירות', icon: 'shopping-cart', setupDays: 3 },
                { id: 'inventory', name: 'מלאי', icon: 'package', setupDays: 5 },
                { id: 'picking', name: 'ליקוט', icon: 'layers', setupDays: 4 },
                { id: 'shipping', name: 'שילוח', icon: 'truck', setupDays: 2 },
                { id: 'marketing', name: 'שיווק', icon: 'megaphone', setupDays: 2 },
                { id: 'mailing', name: 'דיוור', icon: 'mail', setupDays: 1 },
                { id: 'opportunities', name: 'הזדמנויות', icon: 'briefcase', setupDays: 3 },
                { id: 'bi', name: 'BI & דוחות', icon: 'bar-chart-3', setupDays: 5 },
            ],
            tiers: [
                { id: 'S', name: 'Tier S (Basic)', limit: 200, price: 150 },
                { id: 'M', name: 'Tier M (Growth)', limit: 1000, price: 450 },
                { id: 'L', name: 'Tier L (Scale)', limit: 5000, price: 1200 },
                { id: 'ENT', name: 'Tier ENT', limit: 15000, price: 3000 },
            ],
            aiPackages: [
                { id: 'none', name: 'ללא AI', price: 0, description: 'תשתית בלבד', limit: 0, isOneTime: false },
                { id: 'starter', name: 'AI Starter', price: 199, description: 'חיזוי בסיסי', limit: 500, isOneTime: false },
                { id: 'pro', name: 'AI Pro', price: 550, description: 'אופטימיזציה בזמן אמת', limit: 2500, isOneTime: false },
                { id: 'ultra', name: 'AI Ultra', price: 1200, description: 'סוכן מלא + שרשרת אספקה', limit: 10000, isOneTime: false },
            ],
            customSections: [] 
        };

        function App() {
            const STORAGE_KEY = 'oneflow_pro_full_v1_fixed_summary';

            // --- State ---
            const [config, setConfig] = useState(() => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    return saved ? JSON.parse(saved) : DEFAULT_CONFIG;
                } catch { return DEFAULT_CONFIG; }
            });

            // נתוני הצעת מחיר
            const [clientName, setClientName] = useState('');
            const [quoteDate, setQuoteDate] = useState(new Date().toISOString().split('T')[0]);
            
            // בחירות המשתמש
            const [selectedModules, setSelectedModules] = useState(['sales', 'inventory', 'bi']);
            const [userCount, setUserCount] = useState(5);
            const [selectedTier, setSelectedTier] = useState('S');
            const [selectedAI, setSelectedAI] = useState('none');
            const [customSelections, setCustomSelections] = useState({});
            
            // UI
            const [isAdminOpen, setIsAdminOpen] = useState(false);
            const [showSummary, setShowSummary] = useState(false);
            const [iconPickerOpen, setIconPickerOpen] = useState(null); 

            // Admin Inputs
            const [newModule, setNewModule] = useState({ name: '', icon: 'package', setupDays: 0 });
            const [newSectionTitle, setNewSectionTitle] = useState('');

            // Persistence
            useEffect(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
                if(window.lucide) window.lucide.createIcons();
            }, [config, selectedModules, isAdminOpen]);

            // --- Calculation Logic ---
            const totals = useMemo(() => {
                const modulesCost = selectedModules.length * config.basePricePerModule;
                const usersCost = userCount * config.basePricePerUser;
                const tierObj = config.tiers.find(t => t.id === selectedTier) || config.tiers[0];
                const backboneTotal = modulesCost + usersCost + tierObj.price;

                let addonsMRR = 0;
                let addonsSetup = 0;
                const mrrBreakdown = []; // למערך פירוט
                
                // AI
                const aiObj = config.aiPackages.find(a => a.id === selectedAI) || config.aiPackages[0];
                if(aiObj.price > 0) {
                    if(aiObj.isOneTime) {
                        addonsSetup += aiObj.price;
                    } else {
                        addonsMRR += aiObj.price;
                        mrrBreakdown.push({ label: `AI: ${aiObj.name}`, price: aiObj.price });
                    }
                }

                // Custom Sections
                const customItems = [];
                config.customSections.forEach(sec => {
                    const pkgId = customSelections[sec.id];
                    const pkg = sec.packages.find(p => p.id === pkgId);
                    if(pkg && pkg.price > 0) {
                        if(pkg.isOneTime) {
                            addonsSetup += pkg.price;
                        } else {
                            addonsMRR += pkg.price;
                            mrrBreakdown.push({ label: `${sec.title}: ${pkg.name}`, price: pkg.price });
                        }
                        customItems.push({ ...pkg, sectionTitle: sec.title });
                    }
                });

                // Setup Days Calculation
                let totalSetupDays = 0;
                const selectedModulesList = config.modules.filter(m => selectedModules.includes(m.id));
                selectedModulesList.forEach(m => totalSetupDays += Number(m.setupDays || 0));
                
                const setupLaborCost = totalSetupDays * config.setupHourlyRate * config.setupHoursPerDay;
                const totalSetup = setupLaborCost + addonsSetup;
                const totalMRR = backboneTotal + addonsMRR;

                return {
                    modulesCost, usersCost, tierObj, backboneTotal,
                    addonsMRR, addonsSetup, customItems, aiObj, mrrBreakdown, // Added mrrBreakdown to return
                    totalSetupDays, setupLaborCost, totalSetup, totalMRR,
                    selectedModulesList,
                    nisMRR: totalMRR * config.exchangeRate,
                    nisSetup: totalSetup * config.exchangeRate
                };
            }, [config, selectedModules, userCount, selectedTier, selectedAI, customSelections]);


            const handlePrint = () => window.print();
            const toggleModule = (id) => setSelectedModules(prev => prev.includes(id) ? prev.filter(m => m !== id) : [...prev, id]);
            
            // --- Admin Helpers ---
            const updateConfigValue = (path, val) => {
               const newConfig = JSON.parse(JSON.stringify(config));
               let current = newConfig;
               for(let i=0; i<path.length-1; i++) current = current[path[i]];
               current[path[path.length-1]] = val;
               setConfig(newConfig);
            };

            const addNewModule = () => {
                if(!newModule.name) return;
                const id = "mod_" + Date.now();
                setConfig(prev => ({ ...prev, modules: [...prev.modules, { ...newModule, id, setupDays: Number(newModule.setupDays) }] }));
                setNewModule({ name: '', icon: 'package', setupDays: 0 });
            };

            const addNewSection = () => {
                if(!newSectionTitle) return;
                const id = "sec_" + Date.now();
                setConfig(prev => ({ ...prev, customSections: [...prev.customSections, { id, title: newSectionTitle, packages: [{ id: id+'_0', name: 'לא נבחר', price: 0, isOneTime: false }] }] }));
                setNewSectionTitle('');
            };

            // --- Render Components ---
            const ModuleButton = ({ module, isSelected }) => (
                <button onClick={() => toggleModule(module.id)} className={`relative flex flex-col items-center justify-center p-4 rounded-xl transition-all border-2 ${isSelected ? 'border-blue-600 bg-blue-50 text-blue-700 shadow-md' : 'border-slate-200 bg-white text-slate-500 hover:border-slate-300'}`}>
                    <div className={`mb-2 ${isSelected ? 'text-blue-600' : 'text-slate-400'}`}><Icon name={module.icon} size={24} /></div>
                    <span className="text-sm font-bold">{module.name}</span>
                    {module.setupDays > 0 && <span className="text-[10px] text-slate-400 mt-1">{module.setupDays} ימי הקמה</span>}
                    {isSelected && <div className="absolute top-2 right-2 text-blue-600"><Icon name="check-circle-2" size={16} /></div>}
                </button>
            );

            return (
                <div dir="rtl" className="min-h-screen bg-slate-50">
                    
                    {/* Header */}
                    <header className="no-print sticky top-0 z-50 bg-white border-b shadow-sm h-16 flex items-center justify-between px-6">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-blue-600 text-white rounded-lg flex items-center justify-center font-bold text-xl">1</div>
                            <h1 className="text-xl font-bold">ONEFLOW <span className="text-blue-600">360 PRO</span></h1>
                        </div>
                        <div className="flex items-center gap-3">
                             <input type="text" placeholder="שם הלקוח" value={clientName} onChange={e => setClientName(e.target.value)} className="hidden md:block p-2 border rounded-lg text-sm w-48 bg-slate-50" />
                             <input type="date" value={quoteDate} onChange={e => setQuoteDate(e.target.value)} className="hidden md:block p-2 border rounded-lg text-sm bg-slate-50" />
                            <button onClick={() => setIsAdminOpen(true)} className="p-2 bg-slate-100 rounded-full hover:bg-slate-200 text-slate-600"><Icon name="settings" /></button>
                        </div>
                    </header>

                    {/* Main Interface */}
                    <main className="no-print max-w-7xl mx-auto p-4 md:p-8 flex flex-col lg:flex-row gap-8">
                        
                        {/* Center Column - Configurator */}
                        <div className="flex-grow space-y-8 pb-24">
                            
                            {/* Mobile Inputs */}
                            <div className="md:hidden space-y-2">
                                <input type="text" placeholder="שם הלקוח" value={clientName} onChange={e => setClientName(e.target.value)} className="w-full p-3 border rounded-xl" />
                                <input type="date" value={quoteDate} onChange={e => setQuoteDate(e.target.value)} className="w-full p-3 border rounded-xl" />
                            </div>

                            {/* Modules */}
                            <section className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700"><Icon name="database" className="text-blue-500"/> {config.uiText.modulesHeader}</h3>
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    {config.modules.map(m => <ModuleButton key={m.id} module={m} isSelected={selectedModules.includes(m.id)} />)}
                                </div>
                            </section>

                            {/* Users */}
                            <section className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold flex items-center gap-2 text-slate-700"><Icon name="users" className="text-blue-500"/> {config.uiText.usersHeader}</h3>
                                    <span className="text-3xl font-black text-slate-900">{userCount}</span>
                                </div>
                                <input type="range" min="1" max="100" value={userCount} onChange={e => setUserCount(Number(e.target.value))} className="w-full h-3 bg-slate-200 rounded-lg cursor-pointer accent-blue-600" />
                            </section>

                            {/* Tiers */}
                            <section className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700"><Icon name="activity" className="text-blue-500"/> {config.uiText.tiersHeader}</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                                    {config.tiers.map(t => (
                                        <button key={t.id} onClick={() => setSelectedTier(t.id)} className={`p-4 rounded-2xl border-2 text-right transition-all ${selectedTier === t.id ? 'border-blue-600 bg-blue-50 ring-1 ring-blue-200' : 'border-slate-100 hover:border-slate-200'}`}>
                                            <div className="font-bold text-slate-700 text-sm">{t.name}</div>
                                            <div className="text-[10px] text-slate-400 mb-2">עד {t.limit.toLocaleString()}</div>
                                            <div className="text-xl font-black text-slate-900">${t.price}</div>
                                        </button>
                                    ))}
                                </div>
                            </section>

                            {/* AI */}
                            <section className="p-6 rounded-3xl border-2 border-violet-100 bg-gradient-to-br from-white to-violet-50/50">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-violet-900"><Icon name="sparkles" className="text-violet-600"/> {config.uiText.aiHeader}</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {config.aiPackages.map(pkg => (
                                        <button key={pkg.id} onClick={() => setSelectedAI(pkg.id)} className={`p-5 rounded-2xl border transition-all text-right ${selectedAI === pkg.id ? 'border-violet-600 bg-white shadow-lg' : 'border-slate-200/60 bg-white/60 hover:bg-white'}`}>
                                            <div className="flex justify-between items-start">
                                                <span className="font-bold text-violet-800">{pkg.name}</span>
                                                <span className="font-black text-lg">${pkg.price}</span>
                                            </div>
                                            <p className="text-xs text-slate-500 mt-1">{pkg.description}</p>
                                        </button>
                                    ))}
                                </div>
                            </section>

                            {/* Custom Sections */}
                            {config.customSections.map(sec => (
                                <section key={sec.id} className="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-slate-700"><Icon name="puzzle" className="text-blue-500"/> {sec.title}</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {sec.packages.map(pkg => (
                                            <button key={pkg.id} onClick={() => setCustomSelections({...customSelections, [sec.id]: pkg.id})} className={`p-4 rounded-2xl border-2 transition-all flex justify-between items-center ${customSelections[sec.id] === pkg.id ? 'border-blue-600 bg-blue-50' : 'border-slate-100'}`}>
                                                <div className="text-right">
                                                    <div className="font-bold text-slate-800">{pkg.name}</div>
                                                    {pkg.isOneTime && <span className="text-[10px] bg-orange-50 text-orange-600 px-2 rounded font-bold">חד-פעמי</span>}
                                                </div>
                                                <div className="text-xl font-black text-slate-900">${pkg.price}</div>
                                            </button>
                                        ))}
                                    </div>
                                </section>
                            ))}
                        </div>

                        {/* Sidebar Summary - Fixed/Sticky Logic */}
                        <div className={`lg:w-96 flex-shrink-0 ${showSummary ? 'fixed inset-0 z-50 bg-white p-6 overflow-y-auto' : 'hidden lg:block'}`}>
                             {showSummary && <button onClick={() => setShowSummary(false)} className="absolute top-4 left-4 p-2 bg-slate-100 rounded-full"><Icon name="x"/></button>}
                             
                             <div className="lg:sticky lg:top-24 bg-white rounded-[2rem] shadow-2xl border border-slate-200 overflow-hidden">
                                <div className="bg-slate-900 text-white p-8">
                                    <h2 className="text-2xl font-black uppercase tracking-tight">סיכום הצעה</h2>
                                </div>
                                <div className="p-8 space-y-6">
                                    {/* Monthly Breakdown */}
                                    <div className="space-y-3 pb-6 border-b border-dashed border-slate-200 text-sm">
                                        <div className="flex justify-between font-bold text-slate-600"><span>תשתית ומודולים</span><span>${totals.backboneTotal.toLocaleString()}</span></div>
                                        
                                        {/* תוספות חודשיות - כאן הפירוט שביקשת! */}
                                        {totals.mrrBreakdown.map((item, i) => (
                                            <div key={i} className="flex justify-between text-blue-600 font-bold bg-blue-50 p-2 rounded">
                                                <span>{item.label}</span>
                                                <span>${item.price.toLocaleString()}</span>
                                            </div>
                                        ))}
                                    </div>

                                    {/* Total MRR */}
                                    <div>
                                        <div className="flex justify-between items-end mb-1">
                                            <span className="text-xs font-black text-blue-600 uppercase tracking-widest">חודשי קבוע (MRR)</span>
                                            <span className="text-4xl font-black text-slate-900 leading-none">${totals.totalMRR.toLocaleString()}</span>
                                        </div>
                                        <div className="text-left text-xs font-bold text-slate-400">≈ {Math.round(totals.nisMRR).toLocaleString()} ₪</div>
                                    </div>

                                    {/* Setup Cost */}
                                    <div className="bg-orange-50 p-6 rounded-2xl border border-orange-100">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-xs font-black text-orange-800 uppercase tracking-wide">הקמה חד-פעמית</span>
                                            <span className="text-2xl font-black text-orange-700">${totals.totalSetup.toLocaleString()}</span>
                                        </div>
                                        <div className="text-left text-[10px] text-orange-600 font-bold mb-3 border-t border-orange-200 pt-2">≈ {Math.round(totals.nisSetup).toLocaleString()} ₪</div>
                                        <div className="flex items-center gap-2 text-xs font-black text-orange-800 bg-white/50 p-2 rounded-lg">
                                            <Icon name="clock" size={16}/> <span>זמן משוער: {totals.totalSetupDays} ימי עבודה</span>
                                        </div>
                                    </div>

                                    <button onClick={handlePrint} className="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-black text-lg rounded-xl shadow-lg flex items-center justify-center gap-2">
                                        <Icon name="file-text"/> צור PDF
                                    </button>
                                </div>
                            </div>
                        </div>
                    </main>
                    
                    {/* Mobile Floating Button */}
                    <div className="no-print fixed bottom-4 left-4 right-4 lg:hidden z-40">
                        <button onClick={() => setShowSummary(true)} className="w-full bg-slate-900 text-white p-4 rounded-full shadow-2xl flex justify-between font-bold border border-slate-700">
                            <span>סיכום עסקה</span>
                            <span>${totals.totalMRR.toLocaleString()} /חודש</span>
                        </button>
                    </div>

                    {/* --- Admin Full Screen Modal --- */}
                    {isAdminOpen && (
                        <div className="admin-modal fixed inset-0 z-[60] bg-white overflow-hidden flex flex-col">
                            {/* Admin Header */}
                            <div className="flex justify-between items-center p-6 border-b bg-slate-50">
                                <h2 className="text-2xl font-bold flex items-center gap-2 text-slate-800"><Icon name="settings" className="text-blue-600"/> הגדרות מערכת מתקדמות</h2>
                                <div className="flex gap-4">
                                    <button onClick={() => {if(confirm("לאפס הכל?")) {localStorage.removeItem(STORAGE_KEY); setConfig(DEFAULT_CONFIG);}}} className="text-red-500 font-bold text-sm flex items-center gap-1 bg-white border border-red-200 px-3 py-1.5 rounded-lg"><Icon name="rotate-ccw" size={14}/> איפוס</button>
                                    <button onClick={() => setIsAdminOpen(false)} className="bg-slate-900 text-white px-6 py-2 rounded-lg font-bold">שמור וסגור</button>
                                </div>
                            </div>

                            {/* Admin Content - Scrollable */}
                            <div className="flex-grow overflow-y-auto p-8 custom-scroll">
                                <div className="max-w-5xl mx-auto space-y-12">
                                    
                                    {/* Global Settings */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div className="p-6 bg-white rounded-2xl border shadow-sm">
                                            <h3 className="font-bold mb-4 text-lg border-b pb-2">תמחור בסיס ($)</h3>
                                            <div className="grid grid-cols-2 gap-6">
                                                <div><label className="text-xs font-bold text-slate-500 mb-1 block">מחיר למודול</label><input type="number" className="w-full p-3 border rounded-xl bg-slate-50" value={config.basePricePerModule} onChange={e => updateConfigValue(['basePricePerModule'], Number(e.target.value))} /></div>
                                                <div><label className="text-xs font-bold text-slate-500 mb-1 block">מחיר למשתמש</label><input type="number" className="w-full p-3 border rounded-xl bg-slate-50" value={config.basePricePerUser} onChange={e => updateConfigValue(['basePricePerUser'], Number(e.target.value))} /></div>
                                            </div>
                                        </div>
                                        <div className="p-6 bg-orange-50 rounded-2xl border border-orange-100">
                                            <h3 className="font-bold mb-4 text-orange-800 text-lg border-b border-orange-200 pb-2">הגדרות פרויקט והקמה</h3>
                                            <div className="grid grid-cols-2 gap-6">
                                                <div><label className="text-xs font-bold text-orange-700 mb-1 block">תעריף שעה ($)</label><input type="number" className="w-full p-3 border border-orange-200 rounded-xl bg-white" value={config.setupHourlyRate} onChange={e => updateConfigValue(['setupHourlyRate'], Number(e.target.value))} /></div>
                                                <div><label className="text-xs font-bold text-orange-700 mb-1 block">שער דולר (₪)</label><input type="number" step="0.1" className="w-full p-3 border border-orange-200 rounded-xl bg-white" value={config.exchangeRate} onChange={e => updateConfigValue(['exchangeRate'], Number(e.target.value))} /></div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Modules Management */}
                                    <div>
                                        <h3 className="font-bold text-xl mb-4 text-slate-800">ניהול מודולים</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                            {config.modules.map((m, idx) => (
                                                <div key={m.id} className="flex gap-3 items-center bg-white border p-3 rounded-xl shadow-sm">
                                                    <button 
                                                        onClick={() => setIconPickerOpen(iconPickerOpen === idx ? null : idx)} 
                                                        className="p-3 bg-slate-100 rounded-lg hover:bg-blue-50 text-slate-600 hover:text-blue-600 transition-colors relative"
                                                    >
                                                        <Icon name={m.icon} size={20}/>
                                                        {iconPickerOpen === idx && (
                                                            <div className="absolute top-12 right-0 z-50 bg-white border shadow-xl rounded-xl p-3 grid grid-cols-5 gap-2 w-64 h-48 overflow-y-auto">
                                                                {ICON_LIST.map(icon => (
                                                                    <button key={icon} onClick={(e) => { e.stopPropagation(); updateConfigValue(['modules', idx, 'icon'], icon); setIconPickerOpen(null); }} className="p-2 hover:bg-slate-100 rounded"><Icon name={icon} size={16}/></button>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </button>
                                                    <div className="flex-grow">
                                                        <label className="text-[10px] text-slate-400 font-bold">שם המודול</label>
                                                        <input value={m.name} onChange={e => updateConfigValue(['modules', idx, 'name'], e.target.value)} className="w-full p-1 bg-transparent border-b border-slate-200 focus:border-blue-500 outline-none font-bold text-slate-700"/>
                                                    </div>
                                                    <div className="w-20">
                                                        <label className="text-[10px] text-slate-400 font-bold">ימי הקמה</label>
                                                        <input type="number" value={m.setupDays} onChange={e => updateConfigValue(['modules', idx, 'setupDays'], Number(e.target.value))} className="w-full p-1 bg-slate-50 border rounded text-center text-sm font-bold"/>
                                                    </div>
                                                    <button onClick={() => {
                                                        const newMods = config.modules.filter(x => x.id !== m.id);
                                                        updateConfigValue(['modules'], newMods);
                                                    }} className="text-red-300 hover:text-red-500"><Icon name="trash-2" size={18}/></button>
                                                </div>
                                            ))}
                                        </div>
                                        {/* Add Module */}
                                        <div className="flex gap-4 bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300 items-end">
                                            <div className="flex-grow">
                                                <label className="text-xs font-bold text-slate-500 mb-1 block">שם מודול חדש</label>
                                                <input value={newModule.name} onChange={e => setNewModule({...newModule, name: e.target.value})} className="w-full p-2 border rounded-lg bg-white"/>
                                            </div>
                                            <div className="w-24">
                                                <label className="text-xs font-bold text-slate-500 mb-1 block">ימים</label>
                                                <input type="number" value={newModule.setupDays} onChange={e => setNewModule({...newModule, setupDays: Number(e.target.value)})} className="w-full p-2 border rounded-lg bg-white"/>
                                            </div>
                                            <button onClick={addNewModule} className="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700">הוסף</button>
                                        </div>
                                    </div>

                                    {/* AI Packages */}
                                    <div>
                                        <h3 className="font-bold text-xl mb-4 text-violet-700">חבילות AI</h3>
                                        <div className="space-y-3">
                                            {config.aiPackages.map((pkg, idx) => (
                                                <div key={pkg.id} className="flex flex-wrap md:flex-nowrap gap-4 items-end bg-white p-4 rounded-xl border shadow-sm">
                                                    <div className="w-full md:w-1/4">
                                                        <label className="text-[10px] font-bold text-slate-400">שם החבילה</label>
                                                        <input value={pkg.name} onChange={e => updateConfigValue(['aiPackages', idx, 'name'], e.target.value)} className="w-full p-2 border rounded-lg font-bold text-sm"/>
                                                    </div>
                                                    <div className="flex-grow">
                                                        <label className="text-[10px] font-bold text-slate-400">תיאור</label>
                                                        <input value={pkg.description} onChange={e => updateConfigValue(['aiPackages', idx, 'description'], e.target.value)} className="w-full p-2 border rounded-lg text-sm"/>
                                                    </div>
                                                    <div className="w-24">
                                                        <label className="text-[10px] font-bold text-slate-400">מחיר ($)</label>
                                                        <input type="number" value={pkg.price} onChange={e => updateConfigValue(['aiPackages', idx, 'price'], Number(e.target.value))} className="w-full p-2 border rounded-lg font-bold text-sm"/>
                                                    </div>
                                                    <div className="pb-2">
                                                        <label className="flex items-center gap-2 text-xs font-bold cursor-pointer bg-slate-50 px-3 py-2 rounded-lg border">
                                                            <input type="checkbox" checked={pkg.isOneTime} onChange={e => updateConfigValue(['aiPackages', idx, 'isOneTime'], e.target.checked)} className="w-4 h-4"/> חד-פעמי
                                                        </label>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Custom Sections */}
                                    <div className="pt-8 border-t">
                                        <h3 className="font-bold text-xl mb-6 text-slate-800">אזורים מותאמים אישית (תוספות)</h3>
                                        {config.customSections.map((sec, sIdx) => (
                                            <div key={sec.id} className="mb-8 bg-slate-50 p-6 rounded-2xl border border-slate-200 relative group">
                                                <button onClick={() => {
                                                    const newSecs = [...config.customSections];
                                                    newSecs.splice(sIdx, 1);
                                                    updateConfigValue(['customSections'], newSecs);
                                                }} className="absolute top-4 left-4 text-red-400 hover:text-red-600 bg-white p-2 rounded-lg shadow-sm border opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={16}/></button>
                                                
                                                <div className="mb-4">
                                                    <label className="text-xs font-bold text-slate-500">כותרת האזור</label>
                                                    <input value={sec.title} onChange={e => updateConfigValue(['customSections', sIdx, 'title'], e.target.value)} className="text-xl font-bold bg-transparent border-b-2 border-slate-300 w-full outline-none focus:border-blue-500 py-1"/>
                                                </div>
                                                
                                                <div className="space-y-3">
                                                    {sec.packages.map((pkg, pIdx) => (
                                                        <div key={pkg.id} className="flex flex-wrap md:flex-nowrap gap-3 items-center bg-white p-3 rounded-xl border">
                                                            <input value={pkg.name} onChange={e => updateConfigValue(['customSections', sIdx, 'packages', pIdx, 'name'], e.target.value)} className="flex-grow p-2 border rounded-lg text-sm" placeholder="שם פריט"/>
                                                            <div className="relative">
                                                                <span className="absolute left-2 top-2 text-slate-400 text-xs">$</span>
                                                                <input type="number" value={pkg.price} onChange={e => updateConfigValue(['customSections', sIdx, 'packages', pIdx, 'price'], Number(e.target.value))} className="w-24 p-2 pl-4 border rounded-lg text-sm font-bold"/>
                                                            </div>
                                                            <label className="flex items-center gap-1 text-xs bg-slate-50 px-2 py-2 rounded border cursor-pointer"><input type="checkbox" checked={pkg.isOneTime} onChange={e => updateConfigValue(['customSections', sIdx, 'packages', pIdx, 'isOneTime'], e.target.checked)}/> חד-פעמי</label>
                                                            <button onClick={() => {
                                                                const newSecs = [...config.customSections];
                                                                newSecs[sIdx].packages.splice(pIdx, 1);
                                                                updateConfigValue(['customSections'], newSecs);
                                                            }} className="text-red-300 hover:text-red-500"><Icon name="x" size={18}/></button>
                                                        </div>
                                                    ))}
                                                    <button onClick={() => {
                                                        const newSecs = [...config.customSections];
                                                        newSecs[sIdx].packages.push({ id: Date.now(), name: 'פריט חדש', price: 0, isOneTime: false });
                                                        updateConfigValue(['customSections'], newSecs);
                                                    }} className="text-sm font-bold text-blue-600 mt-2 flex items-center gap-1">+ הוסף שורה</button>
                                                </div>
                                            </div>
                                        ))}
                                        
                                        <div className="flex gap-3 bg-white p-4 rounded-xl border border-blue-100 shadow-sm items-center">
                                            <input value={newSectionTitle} onChange={e => setNewSectionTitle(e.target.value)} placeholder="שם אזור חדש (למשל: חבילות תמיכה)..." className="flex-grow p-3 border rounded-xl bg-slate-50"/>
                                            <button onClick={addNewSection} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-slate-800">צור אזור</button>
                                        </div>
                                    </div>
                                </div>
                                <button onClick={() => setIsAdminOpen(false)} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg sticky bottom-0 shadow-xl">שמור וסגור</button>
                            </div>
                        </div>
                    )}

                    {/* --- אזור הדפסה (PDF) מוסתר - נחשף רק בהדפסה --- */}
                    <div id="print-area">
                        <div className="print-container">
                            {/* כותרת מסמך */}
                            <div className="quote-header">
                                <div>
                                    <h1>הצעת מחיר: ONEFLOW 360 PRO</h1>
                                    <div className="print-sub-header">
                                        <p><strong>לכבוד:</strong> {clientName || "לקוח יקר"}</p>
                                        <p><strong>תאריך:</strong> {new Date(quoteDate).toLocaleDateString('he-IL')}</p>
                                    </div>
                                </div>
                                <div style={{textAlign: 'left'}}>
                                    <h2 style={{margin:0, fontSize:'22pt', color:'#2563eb'}}>ONEBTN</h2>
                                    <p style={{fontSize:'10pt', letterSpacing:'1px', textTransform:'uppercase'}}>Digital Backbone Solutions</p>
                                </div>
                            </div>

                            {/* טבלת מודולים */}
                            <h2>1. מפרט מודולים ותכולת פרויקט</h2>
                            <table className="print-table">
                                <thead>
                                    <tr>
                                        <th>מודול</th>
                                        <th style={{width:'100px', textAlign:'center'}}>ימי הקמה</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {totals.selectedModulesList.map(m => (
                                        <tr key={m.id}>
                                            <td style={{fontWeight:'bold'}}>{m.name}</td>
                                            <td style={{textAlign:'center'}}>{m.setupDays}</td>
                                        </tr>
                                    ))}
                                    <tr style={{backgroundColor:'#f8fafc', fontWeight:'bold'}}>
                                        <td>סה"כ ימי אפיון והקמה למודולים</td>
                                        <td style={{textAlign:'center'}}>{totals.selectedModulesList.reduce((acc, m) => acc + (m.setupDays || 0), 0)}</td>
                                    </tr>
                                </tbody>
                            </table>

                            {/* טבלת רישוי */}
                            <h2>2. רישוי, חבילות ותוספות</h2>
                            <table className="print-table">
                                <thead>
                                    <tr>
                                        <th>רכיב</th>
                                        <th>פירוט</th>
                                        <th style={{textAlign:'center'}}>סוג חיוב</th>
                                        <th>מחיר</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style={{fontWeight:'bold'}}>משתמשים</td>
                                        <td>{userCount} משתמשים במערכת</td>
                                        <td style={{textAlign:'center'}}><span className="badge">חודשי</span></td>
                                        <td>${totals.usersCost.toLocaleString()}</td>
                                    </tr>
                                    <tr>
                                        <td style={{fontWeight:'bold'}}>חבילת טרנזקציות</td>
                                        <td>{totals.tierObj.name} (עד {totals.tierObj.limit.toLocaleString()} פעולות)</td>
                                        <td style={{textAlign:'center'}}><span className="badge">חודשי</span></td>
                                        <td>${totals.tierObj.price.toLocaleString()}</td>
                                    </tr>
                                    {/* AI Row */}
                                    {totals.aiObj.price > 0 && (
                                        <tr>
                                            <td style={{fontWeight:'bold', color:'#7c3aed'}}>AI: {totals.aiObj.name}</td>
                                            <td>{totals.aiObj.description}</td>
                                            <td style={{textAlign:'center'}}>
                                                <span className="badge" style={{backgroundColor: totals.aiObj.isOneTime ? '#fff7ed' : '#eff6ff', color: totals.aiObj.isOneTime ? '#c2410c' : '#1e40af'}}>
                                                    {totals.aiObj.isOneTime ? 'חד-פעמי' : 'חודשי'}
                                                </span>
                                            </td>
                                            <td>${totals.aiObj.price.toLocaleString()}</td>
                                        </tr>
                                    )}
                                    {/* Custom Rows */}
                                    {totals.customItems.map((item, idx) => (
                                        <tr key={idx}>
                                            <td style={{fontWeight:'bold'}}>{item.sectionTitle}: {item.name}</td>
                                            <td>{item.description || '-'}</td>
                                            <td style={{textAlign:'center'}}>
                                                <span className="badge" style={{backgroundColor: item.isOneTime ? '#fff7ed' : '#eff6ff', color: item.isOneTime ? '#c2410c' : '#1e40af'}}>
                                                    {item.isOneTime ? 'חד-פעמי' : 'חודשי'}
                                                </span>
                                            </td>
                                            <td>${item.price.toLocaleString()}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>

                            {/* סיכום עלויות */}
                            <div className="summary-box">
                                <h3 style={{marginTop:0, borderBottom:'none', fontSize:'18pt', color:'#1e3a8a'}}>סיכום עלויות הפרויקט</h3>
                                
                                <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-end', marginBottom:'20px'}}>
                                    <div style={{fontSize:'14pt', fontWeight:'bold'}}>סה"כ תשלום חודשי קבוע (MRR):</div>
                                    <div style={{textAlign:'left'}}>
                                        <div style={{fontSize:'22pt', fontWeight:'900', color:'#1e3a8a', lineHeight:1}}>${totals.totalMRR.toLocaleString()}</div>
                                        <div style={{fontSize:'11pt', color:'#64748b'}}>≈ {Math.round(totals.nisMRR).toLocaleString()} ₪</div>
                                    </div>
                                </div>

                                <div style={{display:'flex', justifyContent:'space-between', alignItems:'flex-end', paddingTop:'20px', borderTop:'1px dashed #94a3b8'}}>
                                    <div>
                                        <div style={{fontSize:'14pt', fontWeight:'bold', color:'#c2410c'}}>סה"כ עלות הקמה חד-פעמית (Setup):</div>
                                        <div style={{fontSize:'10pt', color:'#ea580c', marginTop:'5px'}}>כולל אפיון, הטמעה והדרכה ({totals.totalSetupDays} ימי עבודה משוערים)</div>
                                    </div>
                                    <div style={{textAlign:'left'}}>
                                        <div style={{fontSize:'22pt', fontWeight:'900', color:'#c2410c', lineHeight:1}}>${totals.totalSetup.toLocaleString()}</div>
                                        <div style={{fontSize:'11pt', color:'#9a3412'}}>≈ {Math.round(totals.nisSetup).toLocaleString()} ₪</div>
                                    </div>
                                </div>
                            </div>

                            <div style={{marginTop:'50px', textAlign:'center', fontSize:'10pt', color:'#64748b', borderTop:'1px solid #e2e8f0', paddingTop:'20px'}}>
                                <p>המחירים אינם כוללים מע"מ כחוק | שער דולר לחישוב: {config.exchangeRate} ₪</p>
                                <p>תוקף ההצעה: 14 ימי עסקים</p>
                                <p style={{fontWeight:'bold', marginTop:'10px'}}>ONEFLOW PRO ERP Hybrid Infrastructure</p>
                            </div>
                        </div>
                    </div>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
